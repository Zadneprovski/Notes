Микроконтроллеры STM32 на ядре **Cortex-M4/M7** поддерживают два режима доступа к Flash-памяти, определяемые битом **DBANK** в регистре **FLASH_OPTCR**:

|Режим|Название|Размер линии чтения|Минимальное время исполнения линии|
|---|---|---|---|
|Single Bank|`DBANK = 0`|128 бит (4×32 бит)|≥ 4 такта CPU|
|Dual Bank|`DBANK = 1`|64 бит (2×32 бит)|≥ 2 такта CPU|

### Принцип работы

- CPU получает инструкции через **шину ICode**, а данные (литералы, константы) — через **шину DCode**.
- Flash-память читается не по одному слову, а **блоками (instruction lines)**, которые сохраняются в буфере предвыборки (prefetch buffer).
- В зависимости от режима (Single/Dual Bank) меняется **размер блока** и **параллелизм доступа**.

---

## Разбор режимов

### **Single Bank (DBANK = 0)**

#### Характеристики:

- **Размер линии:** 128 бит (4 инструкции × 32 бита или 8 инструкций × 16 бит).
- **Минимальное время обработки линии:** 4 такта CPU.
- **Эффективность:** Максимальная пропускная способность при **последовательном доступе** (например, в циклах или DSP-алгоритмах).
#### Преимущества:

- **Высокая скорость линейного исполнения** благодаря предвыборке следующей линии во время обработки текущей.
- **Меньше энергозатрат** на чтение Flash (реже обращения).

#### Недостатки:

- **Задержки при ветвлениях**: При прыжках (branch, interrupt) предвыборка становится неактуальной, и требуется перезагрузка новой линии.

#### Когда использовать:
- Код **линейный** (математические вычисления, обработка массивов).
- Нет необходимости в **параллельном доступе** к разным участкам Flash.
- Flash-память **не разделена на банки** (например, в STM32F1).

---

### **Dual Bank (DBANK = 1)**

#### Характеристики:

- **Размер линии:** 64 бита (2 инструкции × 32 бита или 4 инструкции × 16 бит).
- **Минимальное время обработки линии:** 2 такта CPU.
- **Эффективность:** Лучшая реакция на **ветвления** и **параллельный доступ**.

#### Преимущества:

- **Быстрая реакция на прерывания и прыжки** — меньший объем неактуальных данных при смене потока исполнения.
- **Поддержка Read-While-Write (RWW)**: Возможность **чтения из одного банка Flash во время записи/стирания в другом** (критично для OTA-обновлений).
- **Оптимизация для многоядерных систем** (например, Cortex-M7 + Cortex-M4 в STM32H7).

#### Недостатки:

- **Меньшая пропускная способность** при линейном коде (чаще обращения к Flash).
- **Дополнительные накладные расходы** при переключении между банками.

#### Когда использовать:

- Flash **разделена на два банка** (например, Bank1 и Bank2 в STM32F4/F7).
- Требуется **одновременное исполнение кода и обновление прошивки** (RWW).
- Код содержит **частые ветвления** (сложная логика, RTOS).

---

## Технические детали реализации

### **Read-While-Write (RWW)**

В режиме Dual Bank возможна **параллельная работа с разными банками Flash**:

- **Пример:**
    - CPU исполняет код из **Bank1**.
    - В это время загрузчик (bootloader) записывает данные в **Bank2**.

- **Ограничения:**
    - Запрещено чтение и запись в **один и тот же банк** одновременно.
    - Требуется корректное выравнивание секторов (sector alignment).

### **Влияние на прерывания**

- В Dual Bank **задержки прерываний снижаются**, так как объем перезагружаемых данных при смене контекста меньше.

- В Single Bank прерывания могут приводить к **сбросу буфера предвыборки** и потере тактов.

---

## Рекомендации по выбору режима

1. **Single Bank (DBANK = 0)**:
    
    - DSP-алгоритмы (FFT, FIR).
    - Линейные вычисления (матричные операции).
    - Системы с **однобанковой Flash** (например, STM32F1).

2. **Dual Bank (DBANK = 1)**:
    
    - RTOS с частыми переключениями задач.
    - OTA-обновления (RWW).
    - Микроконтроллеры с **двухбанковой Flash** (например, STM32F4/F7/L4).

Для точной настройки рекомендуется:

- Проверить **разметку банков Flash** в документации (например, RM0399 для STM32F7).
- Измерить производительность с помощью **циклового счетчика (DWT->CYCCNT)**.