После сброса Flash control register (FLASH_CR) недоступен для записи, её нужно разблокировать следующим образом:
- Записать ключ KEY1 = 0x45670123 в Flash key register (FLASH_KEYR) 
-  Записать ключ KEY2 = 0xCDEF89AB в FLASH_KEYR register.

Последовательность стирания основной флэш-памяти:
- Операция стирания флэш-памяти может выполняться на уровне страницы, банка или всей флэш-памяти (массовое стирание). 
- Массовое стирание не затрагивает информационный блок **(system flash, OTP, и option bytes)**.

## **Ускоренная запись во Flash STM32: режим Fast Programming**

### **Что это такое?**

Режим **Fast Programming** позволяет значительно ускорить запись данных во Flash-память микроконтроллеров STM32 (F4, F7, H7 и др.). Вместо поштучной записи по 8 байт (double word) он программирует сразу **целый блок данных** (64 double words, 512 байт) за одну операцию.

### **Как это работает?**

1. **Размер блока записи зависит от режима Flash:**
    
    - **Dual Bank (DBANK=1):** 64 double words (вся строка)
    - **Single Bank (DBANK=0):** 64 double words (половина строки)

2. **Ключевые особенности:**
    
    - Отключает автоматическую проверку данных (верификацию)
    - Включает высокое напряжение только один раз для всего блока
    - Требует предварительного стирания сектора

3. **Ограничения:**
    
    - Работает только с основной Flash (не для Option Bytes)
    - Минимальная частота CPU: 8 МГц
    - Нельзя прерывать операцию записи

### **Скорость записи**

|Режим|Время записи 512 байт|Верификация|
|---|---|---|
|Обычный|~5 мс|Да|
|Fast Programming|~1 мс|Нет|
**Ускорение: в 2-5 раз**
### **Когда использовать?**

Идеально для:
- Загрузки прошивки (Bootloader, OTA)
- Записи больших массивов данных
- Быстрой инициализации устройства

Не подходит для:
- Точечного изменения отдельных байт
- Работы с Option Bytes
- Систем с нестабильным питанием

### **Защита прошивки с помощью CRC при использовании Fast Programming**

 **Почему CRC критически важен?**

При использовании Fast Programming с отключённой аппаратной верификацией контрольная сумма (CRC) становится основным механизмом гарантии целостности данных. Без CRC вы рискуете получить:
- **Коррупцию прошивки** из-за сбоев питания
- **Частично записанные блоки** при прерывании операции
- **Ошибки в критических секциях** (загрузчик, конфигурация)

### **3-уровневая система защиты**

#### **1. Контрольная сумма прошивки (Pre-CRC)**
**Где хранить:** Последние 4 байта образа прошивки или отдельный сектор Flash

#### **2. Верификация после записи (Post-CRC)**
**Особенности:**
- Выполняется после полной записи
- При ошибке - триггер аварийного восстановления

#### **3. Контроль целостности при загрузке (Boot-Time CRC)**
## **Практические рекомендации**

1. **Двойной буфер прошивки**
    - Активная и резервная копии
    - Переключение только после успешного CRC

## **Сравнение методов верификации**

|Метод|Время (512KB)|Точность|Память|
|---|---|---|---|
|Аппаратный CRC32|12 мс|99.9999%|4 байта|
|Программный CRC16|85 мс|99.99%|2 байта|
|SHA-256 (полный)|320 мс|100%|32 байта|
|Контрольная сумма|45 мс|99.9%|2 байта|

## **Взаимодействие Flash-памяти и кэшей в STM32 требует особого внимания при программировании.** 
Когда происходит запись или стирание Flash, данные в кэшах процессора (Data Cache и Instruction Cache) могут оставаться неизменными, что приводит к чтению устаревшей информации. 
Особенно критично это при стирании секторов — кэш продолжает хранить старые данные, хотя Flash уже очищена. Для предотвращения ошибок необходимо либо сбрасывать кэши принудительно (установкой битов `DCRST` и `ICRST` в регистре `FLASH_ACR`), либо точечно инвалидировать затронутые области. В высоконадёжных сценариях (например, при обновлении прошивки) рекомендуется временно отключать кэши. Это гарантирует согласованность данных между Flash и кэшем, исключая риск выполнения устаревшего кода или чтения некорректных данных.
