[[Установка размера кучи и стека STM32]]
# Основные функции стека

 - **Хранение адресов возврата из функций**
	 Стек используется для хранения адресов возврата при вызовах функций. Когда вызывается функция, адрес следующей инструкции, которую нужно выполнить после завершения функции, сохраняется в стеке. Это позволяет программе вернуться в правильное место после завершения функции.
 
 - **Хранение локальных переменных**
	 Локальные переменные функций хранятся в стеке. Это позволяет каждой функции иметь свои независимые переменные, которые не мешают друг другу.

 - **Передача параметров функций**
	 Параметры передаются через стек, если их много и они не помещаются в регистры процессора

 - **Сохранение регистров процессора**
	 При вызовах функций или при обработке прерываний регистры процессора сохраняются в стек, чтобы после выполнения функции или обработчика прерываний восстановить исходное состояние.

# Пример создания и использования локальных переменных

Когда вы создаете локальные переменные в функции, компилятор создает код, который использует стек для их хранения. Рассмотрим пример:

```cpp
void function() {
    int a = 10;
    int b = 20;
    int c = a + b;
}
```

## Компиляция и генерация ассемблерного кода

Когда компилятор обрабатывает эту функцию, он генерирует ассемблерный код, который управляет локальными переменными с помощью стека.

## Пример ассемблерного кода (ARM)

```asm
function:
    PUSH {LR}           ; Сохранение адреса возврата
    SUB  SP, SP, #12    ; Выделение места в стеке для локальных переменных (3 * 4 байта)
    MOV  R0, #10        ; R0 = 10
    STR  R0, [SP, #0]   ; Сохранение R0 (значение a) по адресу SP
    MOV  R1, #20        ; R1 = 20
    STR  R1, [SP, #4]   ; Сохранение R1 (значение b) по адресу SP + 4
    LDR  R2, [SP, #0]   ; Загрузка значения a из стека в R2
    LDR  R3, [SP, #4]   ; Загрузка значения b из стека в R3
    ADD  R2, R2, R3     ; R2 = a + b
    STR  R2, [SP, #8]   ; Сохранение результата (c) по адресу SP + 8
    ADD  SP, SP, #12    ; Освобождение памяти в стеке
    POP  {LR}           ; Восстановление адреса возврата
    BX   LR             ; Возврат к месту вызова
```


# Обращение к данным в глубине стека

Если в коде нужно обратиться к переменным, которые находятся глубже в стеке, процессор использует инструкции с указанием смещения. Пример:

```asm
LDR  R0, [SP, #0]  ; Загрузка значения переменной a из стека в регистр R0
LDR  R1, [SP, #4]  ; Загрузка значения переменной b из стека в регистр R1
LDR  R2, [SP, #8]  ; Загрузка значения переменной c из стека в регистр R2
```

# Автоматическое управление указателем стека

В архитектуре ARM команды `PUSH` и `POP` являются специальными инструкциями для работы со стеком. Они автоматически управляют указателем стека (SP) и не требуют явного указания смещения адреса. Давайте посмотрим, как это происходит:

1. **PUSH {LR}**:

    - Сохранение значения регистра LR в стек.
    - Автоматическое уменьшение указателя стека (SP) на 4 байта (для 32-битных регистров).

2. **POP {LR}**:

    - Извлечение значения из стека в регистр LR.
    - Автоматическое увеличение указателя стека (SP) на 4 байта.

