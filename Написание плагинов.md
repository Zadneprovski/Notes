# Расширения для RG Power Configurator

Начиная с версии **2.0.0**, RG Power Configurator предоставляет возможность создания расширений. Данная возможность позволяет гибко расширять функционал приложения без пересборки родительской программы. В данной статье описывается поэтапная настройка рабочей области, IDE Visual Studio для быстрого перехода к разработке самих расширений, а также кратко затронута архитектура.

## Установка IDE

Перед началом работы требуется установить IDE Visual Studio. Данный программный продукт возможно скачать на специализированном сайте. При установке требуется выбрать все основные компоненты .NET. После установки, первого запуска, настройки темы возможно перейти к специализированному этапу.

После установки IDE также требуется выполнить следующий скрипт в Power Shell (Администратор) и перезагрузить ПК.

```plaintext
New-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\FileSystem" `
-Name "LongPathsEnabled" -Value 1 -PropertyType DWORD -Force
```

## Установка расширений и зависимостей

**Требуется загрузить следующие компоненты:**

1. [Расширение для Visual Studio](https://git.rg-gr.ru/rgrobotics/configurators/PowerPlugins/RgPowerConfigurator.Plugin/-/releases);
2. [RgPowerConfiguratorSetup.exe, RgPowerConfigurator.Sdk.*.nupkg, Настройки разработчика](https://git.rg-gr.ru/rgrobotics/configurators/RgPowerConfigurator/-/releases);
3. [Библиотека с дополнительными компонентами, конвертерами и анимацией ExtendedWpf](https://git.rg-gr.ru/rgrobotics/libraries/windows/ExtendedWpf/-/releases);
4. Библиотека с компонентами UI (O:\ПРОЕКТЫ\C#\WPF-UI.3.2.1.nupkg и O:\ПРОЕКТЫ\C#\WPF-UI.3.2.1.snupkg);
5. [Библиотека с сущностями RG RGLibrary](https://git.rg-gr.ru/rgrobotics/libraries/windows/rglibrary/-/releases).

**После загрузки следует сделать следующее:** 

1. Установить расширение для Visual Studio (двойным кликом, при необходимости  выбрать, что его следует открыть в Visual Studio и со всем согласиться);
2. Создать папку Local на рабочем диске и скопировать в неё все файлы с расширениями .nupkg и .snupkg;
3. Разархивировать библиотеки, также на рабочем диске.

## Создание первого расширения

Требуется открыть Visual Studio и выбрать проект, как представлено на скриншотах:


После выполнения указанных действий будет создан проект расширения в указанном месте. Далее требуется настроить локальный nuget и зависимости. Для этих целей требуется открыть менеджер пакетов.


Затем перейти в настройки.


И указать путь к папке Local, которая была создана на одном из предыдущих шагов.


Также требуется добавить nuget, если он не добавлен. Информация представлена на предыдущем скриншоте.

После этого требуется указать библиотеки и модули, используемые в проекте. Как минимум RGLibrary.


Далее требуется собрать расширение и запустить отладку. Все действия представлены на скриншотах.


Однако возможно возникновение ряда ошибок. Например:


Возникает она по причине того, что не удалось найти исполняемый файл родительского приложения по указанному пути. Это возможно в случаях, если не совпадают версии или если приложение не установлено. Проверяем версию приложения (в моём случае это 2.9.5). И меняем её в параметрах настроек.


Проверяем пути и меняем версию.


После этого пробуем запустить заново отладку.


Приложение успешно запускается и расширение успешно загружается. Однако, может возникнуть ситуация, когда этого не происходит. В таком случае расширение будет отображаться в менеджере расширения (менеджеры не нужны), как ненайденное.



Следует перепроверить путь, указанный в поле Command line arguments.

После проведения указанных операций возможно приступить к разработке самого расширения, написанию его внутренней логики.

# Описание структуры расширения

Изначально шаблон расширения состоит из нескольких файлов. Давайте их последовательно рассмотрим.

## PluginEntry

Данный файл содержит информацию о точке входа в расширение, а также информацию, предоставляемую родительским приложением.

Одноимённый класс явно реализует интерфейс `IPowerConfiguratorPluginEntry`. Каждое расширение может предоставлять информацию, необходимую для отображения, если расширение требуется отображать, так как возможно создание расширений без графического интерфейса. Для этих целей требуется не указывать тип страницы.

```cs
// Расширение отображается в NavigationView, как "Привет расширение"
IDisplayInfo? IPowerConfiguratorPluginEntry.DisplayInfo { get; } = new DisplayInfo(typeof(MainPage))
{
    DisplayName = "Привет расширение",
    Icon = new SymbolIcon(SymbolRegular.Accessibility24)
};

// Расширение не отображается в NavigationView
IDisplayInfo? IPowerConfiguratorPluginEntry.DisplayInfo { get; } = new DisplayInfo()
{  
    Icon = new SymbolIcon(SymbolRegular.Accessibility24)
};
```

Свойство `CanUnload` отвечает за возможность основного приложения выгрузить данное расширение. Если вы выполняете некоторую длительную активность, которую не следует прерывать, то перед началом следует установить свойство `CanUnload = false`. В таком случае основное приложение будет об этом знать и  потребует дополнительных подтверждений при отключение или удалении расширения. После завершения активности следует установить `CanUnload = true`.

Метод `IPowerConfiguratorPluginEntry.OnInitialize` вызывается из потока UI и выполняет инициализацию UI сущностей расширения.

Метод `IRequireFeatureService.OnFeatureServiceReady` вызывается в тот момент, когда сервис предоставления возможностей готов.

Метод `IPowerConfiguratorPluginEntry.OnLoad` вызывается в момент загрузки расширения.

Метод `IPowerConfiguratorPluginEntry.OnUnload` вызывается в момент выгрузки расшиерния.

Метод `IDisposable.Dispose` вызывается при уничтожении расшиерния.

Бывают ситуации, когда требуется получать обратные вызовы о дополнительных событиях, выполнять какие-либо действия при установке/удалении/обновлении. Для этих целей предусмотрены сущности из пространства имён `Plugin.Management`. Требуется реализовать требуемый интерфейс классом `PluginEntry`, в таком случае будут вызываться требуемые функции обратного вызова.

Доступ к инфраструктуре RgPowerConfigurator-а возможно получить посредством `PluginEntry.Current.XXX`, где XXX - свойство.

Также в классе `PluginEntry` создаются `MainPageViewModel` и `MainPage`.

## Файл проекта

Файл проекта расширения содержит следующие свойства, желательные для редактирования:

```xml
<Version>0.0.1</Version>
<MinimalSdkVersion>1.5.0</MinimalSdkVersion>
<MaximumSdkVersion>2.0.0</MaximumSdkVersion>
<AssemblyName>RgPowerConfigurator.ExamplePlugin</AssemblyName>
<PluginDisplayName>Демонстрационное расширение</PluginDisplayName>
<Description>Расширение, используемое для шаблона расширений Rg Power Configurator-а</Description>
```

От разработчика требуется следить за тем, чтобы мимнимально требуемая версия SDK (`MinimalSdkVersion`) соответствовала версии SDK приложения. При необходимости требуется скачать новое SDK (поставляется на gitlab) и обновить его через nuget. Если актуальная версия SDK - `1.5.0`, то минимальная версия должна быть `1.5.0`

Максимальная версия должна отличаться на 1 мажорную версию.

`AssemblyName` - это название сборки расширения, его желательно изменить, исключив `RgPowerConfigurator.` .  `RgPowerConfigurator.ExamplePlugin → ExamplePlugin`

`PluginDisplayName` - название расширения, отображаемое в “Менеджер расширений” (менеджеры не нужны) RG Power Configurator-а.

`Description` - описание расширения, отображаемое в “Менеджер расширений” (менеджеры не нужны) RG Power Configurator-а.

## MainPageViewModel

Содержит в себе логику для взаимодействия с моделью расширения. Также она может содержать в себе обращения к сервисам RG Power Configurator-а:

```cs
PluginEntry.Current.ConfiguratorServices.Dispatcher.Invoke(delegate {
    PluginEntry.Current.ConfiguratorServices.UserInterface.SnackbarService
               .Show("Сообщение из расширения",
                     "Привет мир!",
                     ControlAppearance.Info,
                     new SymbolIcon(SymbolRegular.Info24),
                     TimeSpan.FromSeconds(5));
});
```

## MainPage

Содержит разметку страницы (.xaml) и CodeBehind (.cs).

## Другие особенности создания, установки и обновления расширений

RgPowerConfigurator не поддерживает Downgrade. Если расширение уже установлено, то возможно установить расширение только с версией > текущей. 

При установке расширения происходит копирование сборки во внутреннюю директорию RgPowerConfigurator-а.

При отладке расширения используется опция запуска RgPowerConfigurator-а `--debug-plugin="путь к файлу расширения"`.  Если отлаживаемое расширение уже установлено, то **требуется его предварительно удалить (перед отладкой)**.

В силу ограниченности времени разработки не были спроектированы полноценные независимые сервисы. Это означает, что в расширения прокидываются сущности, такие как `CanConnection`, `RgProtocol` и другие из основного приложения. **Не следует** вызывать у них метод Dispose или как-то их ломать. Если расширение добавляет CAN фильтры или хендлеры, то оно же и должно их освобождать. Удаление фильтров расширения требуется осуществлять в `OnUnload`/`Dispose`, опционально в `OnNavigatedFrom` и `OnNavigatedTo`. Тоже самое касается и параметров RgProtocol-а и любых других внешних сервисов.

Расширения должны тестироваться, совместно с функционалом основного приложения.

`AssemblyName` расширений **должны быть уникальными**. **Не должно существовать два расширения с одинаковым именем сборки**.

В графическом редакторе Visual Studio отображение некорректно из-за того, что тема является динамическим ресурсом. Для того, чтобы видеть, что получается следует запустить отладку и осуществлять разметку на лету. В таком случае стили будут применяться и отображение в реальном приложении будет изменяться.