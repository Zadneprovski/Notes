Загрузчик (**bootloader**) на Arduino — это небольшая программа, записанная в специальной области флэш-памяти микроконтроллера. Он предназначен для упрощения процесса загрузки прошивок на микроконтроллер через последовательный интерфейс (**UART**) без необходимости использования программатора.

---

### Как работает загрузчик Arduino:

1. **Разделение памяти**:
    
    - У микроконтроллеров AVR (например, ATmega328P на Arduino Uno) флэш-память разделена на две части:
        - **Boot section** — область памяти, зарезервированная для загрузчика. Ее размер задается с помощью фьюз-битов.
        - **Application section** — основная область памяти, где находится пользовательская прошивка.
    - Когда микроконтроллер запускается, он сначала выполняет код из загрузчика (если загрузчик активирован).
2. **Задачи загрузчика**:
    
    - Прослушивание UART на наличие входящих данных (новой прошивки).
    - Проверка наличия команды для записи данных в флэш-память.
    - Если новая прошивка не поступила, загрузчик передает управление основной прошивке.

---

### Алгоритм работы загрузчика Arduino:

1. **Запуск загрузчика**:
    
    - При сбросе (RESET) или включении питания микроконтроллер запускается с адреса, заданного фьюз-битами. При использовании платы Arduino при подключении к последовательному порту, она автоматически сбрасывается ([[Автоматический сброс Ардуино при прошивке|Подробнее]]).
    - Если в фьюз-битах настроено использование загрузчика, выполнение начинается с его кода в **Boot section**.
2. **Прослушивание команды**:

    - Загрузчик ожидает команды загрузки новой прошивки через последовательный интерфейс (UART).
    - Например, Arduino Uno использует интерфейс USB-to-Serial (на базе микросхемы ATmega16U2 или CH340) для связи с ПК.
3. **Передача управления основной программе**:
    
    - Если данные для загрузки не поступают в течение короткого времени (обычно 1–2 секунды), загрузчик передает управление коду основной программы, который начинается в **Application section** (адрес 0x0000).

---

### Технические особенности загрузчика:

#### 1. **Размер загрузчика**:

- Стандартный загрузчик Arduino занимает 512 байт флэш-памяти. Размер задается фьюз-битами.
- Это место вырезается из доступной для пользовательского кода флэш-памяти:
    - У ATmega328P с 32 КБ флэш-памяти доступно только 31.5 КБ (32 КБ - 512 байт).

#### 2. **Протокол загрузки**:

- Загрузчик Arduino использует протокол **stk500** для обмена данными с ПК.
- `avrdude` (используемый Arduino IDE) отправляет данные прошивки и команды записи через последовательный порт.

#### 3. **Отклик на сброс**:

- Arduino автоматически сбрасывается перед началом загрузки прошивки. Это достигается за счет использования DTR-сигнала (или RTS) через USB-to-Serial конвертер.
- Сигнал сброса заставляет микроконтроллер запустить загрузчик.

#### 4. **Код загрузчика**:

- Код загрузчика Arduino открытый. Например, для Arduino Uno используется **Optiboot** — минималистичный и оптимизированный загрузчик.
- Исходный код можно найти в репозитории Arduino: Optiboot.

---

### Настройка и изменения загрузчика:

1. **Настройка фьюз-битов**: Фьюз-биты микроконтроллера определяют:
    
    - Размер Boot section.
    - Использование загрузчика.
    - Тактовую частоту и другие параметры.
    
    Для стандартного Arduino Uno фьюз-биты настроены так:
    
    - `BOOTRST` активирован: микроконтроллер начинает выполнение с Boot section после сброса.
    - Размер загрузчика: 512 байт.
    
    Если загрузчик не нужен, фьюз-биты можно изменить для полного использования флэш-памяти (32 КБ).
    
2. **Прошивка нового загрузчика**: Если нужно заменить или обновить загрузчик:
    
    - Подключите программатор (или используйте Arduino как программатор через **ArduinoISP**).
    - Используйте команду `avrdude`:

```bash
avrdude -c arduino -p m328p -P COM3 -U flash:w:optiboot.hex -U lfuse:w:0xFF:m -U hfuse:w:0xDE:m -U efuse:w:0xFD:m
```
- Замените `optiboot.hex` на путь к файлу загрузчика.

---

### Преимущества использования загрузчика:

1. **Удобство загрузки прошивок**:
    
    - Нет необходимости в отдельном программаторе.
    - Можно прошивать микроконтроллер через USB и Arduino IDE.
2. **Меньший риск блокировки микроконтроллера**:
    
    - Даже если прошивка содержит ошибки, загрузчик останется нетронутым, и вы сможете снова перепрошить устройство.

---

### Если загрузчик не нужен:

- Вы можете стереть загрузчик и использовать всю память микроконтроллера под свою программу.
- Для прошивки в этом случае потребуется программатор или использование Arduino как ISP.
- Управление начнется сразу с вашей программы в **Application section**, без задержки.

---

### Ключевые моменты:

1. **Скорость загрузки**:
    
    - Загрузчик Arduino (Optiboot) поддерживает скорость до 115200 бод, что делает загрузку прошивок быстрой.
2. **Гибкость**:
    
    - Вы можете модифицировать загрузчик для реализации специфических функций, например, поддержки других интерфейсов (I2C, SPI) или добавления проверки прошивки.
3. **Компактность**:
    
    - Optiboot занимает всего 512 байт, оставляя большую часть флэш-памяти для пользовательской программы.
