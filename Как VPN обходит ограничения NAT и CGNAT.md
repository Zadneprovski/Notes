
#### 1. Физическое прохождение через NAT

Когда ваше устройство подключается к интернету через роутер, NAT преобразует локальные IP-адреса (например, 192.168.1.100) в один публичный IP-адрес (например, 203.0.113.10). Это происходит и в случае подключения к VPN-серверу.

#### 2. Установка зашифрованного туннеля

- Ваше устройство инициирует VPN-соединение с VPN-сервером.
- VPN-сервер аутентифицирует соединение и устанавливает зашифрованный туннель.
- Этот туннель инкапсулирует все данные, передаваемые между вашим устройством и VPN-сервером.

#### 3. Представление для NAT как одного соединения

- Для вашего роутера и NAT устройства это VPN-соединение выглядит как одно постоянное соединение между вашим устройством и VPN-сервером.
- Весь трафик проходит через это зашифрованное соединение, и NAT-устройства видят только внешний IP-адрес и порт VPN-сервера.

### Пример работы с NAT и VPN

#### Исходные данные

- Ваше устройство (например, ноутбук) с локальным IP-адресом: `192.168.1.100`
- Локальный роутер с публичным IP-адресом: `203.0.113.10`
- VPN-сервер с публичным IP-адресом: `198.51.100.1`
- Виртуальный IP-адрес вашего устройства через VPN: `10.8.0.2`

#### Подробный процесс

1. **Подключение к VPN**:
    
    - Ваше устройство инициирует соединение с VPN-сервером по IP-адресу `198.51.100.1`.
    - Ваш роутер выполняет NAT, заменяя локальный IP `192.168.1.100` на публичный IP `203.0.113.10`.
2. **Создание туннеля**:
    
    - VPN-сервер устанавливает зашифрованный туннель и присваивает вашему устройству виртуальный IP `10.8.0.2`.
3. **Маршрутизация данных через туннель**:
    
    - Все данные вашего устройства шифруются и инкапсулируются в VPN-пакеты, которые отправляются на VPN-сервер.
    - Эти данные проходят через NAT вашего роутера и CGNAT вашего провайдера, но они уже зашифрованы и инкапсулированы.
4. **Данные VPN-сервера в интернет**:
    
    - VPN-сервер расшифровывает и отправляет данные в интернет от своего публичного IP-адреса `198.51.100.1`.
    - Ответные данные возвращаются на VPN-сервер.
5. **Возвращение данных через туннель**:
    
    - VPN-сервер шифрует и инкапсулирует данные, отправляя их через туннель обратно вашему устройству.
    - Данные проходят через NAT вашего провайдера и роутера, но остаются в зашифрованном туннеле.